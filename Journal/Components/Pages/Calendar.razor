@page "/calendar"
@using JournalApp.Services
@using JournalApp.Models
@using System.Diagnostics
@using Microsoft.AspNetCore.Components.Web
@inject JournalService JournalService
@inject NavigationManager Navigation

<div class="calendar-page">
    <h1>Calendar</h1>
    <p>Navigate through your journal entries by date</p>

    @if (!string.IsNullOrEmpty(errorMessage))
    {
        <div class="alert alert-danger">@errorMessage</div>
    }

    <div class="calendar-controls">
        <button class="btn btn-sm btn-outline-secondary" @onclick="PreviousMonth" disabled="@isLoading">Previous</button>
        <h2>@currentDate.ToString("MMMM yyyy")</h2>
        <button class="btn btn-sm btn-outline-secondary" @onclick="NextMonth" disabled="@isLoading">Next</button>
    </div>

    @if (isLoading)
    {
        <p class="text-muted">Loading calendar...</p>
    }
    else
    {
        <div class="calendar-grid" role="grid" aria-label="Journal calendar">
            <!-- Day headers -->
            @foreach (var day in new[] { "Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat" })
            {
                <div class="calendar-day-header">@day</div>
            }

            <!-- Empty cells before first day of month -->
            @for (int i = 0; i < firstDayOfMonth; i++)
            {
                <div class="calendar-day empty"></div>
            }

            <!-- Days of month -->
            @for (int day = 1; day <= daysInMonth; day++)
            {
                var date = new DateTime(currentDate.Year, currentDate.Month, day).Date;
                var hasEntry = entryDates.Contains(date);
                var isToday = date == DateTime.Today;
                var cssClass = $"calendar-day {(hasEntry ? "has-entry" : "")} {(isToday ? "today" : "")}";

                <div @key="date" class="@cssClass"
                     role="button"
                     tabindex="0"
                     aria-pressed="@(hasEntry ? "true" : "false")"
                     @onclick="() => SelectDate(date)"
                     @onkeydown="(e) => HandleKeyDown(date, e)">
                    <span class="day-number">@day</span>
                    @if (hasEntry)
                    {
                        <span class="entry-indicator" aria-hidden="true">•</span>
                    }
                </div>
            }
        </div>
    }

    @if (selectedDateEntries?.Any() == true)
    {
        <div class="selected-date-entries mt-3">
            <h3>Entries for @selectedDate.ToString("MMMM dd, yyyy")</h3>
            @foreach (var entry in selectedDateEntries)
            {
                <div class="entry-preview" @onclick="() => ViewEntry(entry.Id)" style="cursor:pointer">
                    <h4>@entry.Title</h4>
                    <p>@(entry.Content ?? "No description")</p>
                </div>
            }
        </div>
    }
</div>

@code {
    private DateTime currentDate = DateTime.Today;
    private DateTime selectedDate = DateTime.Today;
    private HashSet<DateTime> entryDates = new();
    private List<JournalEntry> selectedDateEntries = new();
    private int daysInMonth;
    private int firstDayOfMonth;
    private bool isLoading = false;
    private string? errorMessage;

    protected override async Task OnInitializedAsync()
    {
        await LoadCalendarData();
    }

    private async Task LoadCalendarData()
    {
        isLoading = true;
        errorMessage = null;

        try
        {
            // Get all entries (service may return null)
            var allEntries = await JournalService.GetEntriesAsync() ?? new List<JournalEntry>();

            // Normalize to local dates and create a HashSet for quick lookup
            entryDates = allEntries
                .Select(e => e.Date.ToLocalTime().Date)
                .Distinct()
                .ToHashSet();

            // Calculate calendar data
            daysInMonth = DateTime.DaysInMonth(currentDate.Year, currentDate.Month);
            firstDayOfMonth = (int)new DateTime(currentDate.Year, currentDate.Month, 1).DayOfWeek;

            // Load entries for selected date (normalize selectedDate to Date)
            await LoadEntriesForDate(selectedDate.Date);
        }
        catch (Exception ex)
        {
            Debug.WriteLine($"LoadCalendarData error: {ex.Message}");
            errorMessage = "Unable to load calendar data.";
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task LoadEntriesForDate(DateTime date)
    {
        selectedDate = date.Date;
        try
        {
            selectedDateEntries = await JournalService.GetEntriesByDateAsync(selectedDate) ?? new List<JournalEntry>();
        }
        catch (Exception ex)
        {
            Debug.WriteLine($"LoadEntriesForDate error: {ex.Message}");
            selectedDateEntries = new List<JournalEntry>();
        }
    }

    private async Task SelectDate(DateTime date)
    {
        // Keep local selection and show entries in the side panel
        await LoadEntriesForDate(date);

        // If an entry exists for the selected date, navigate to the view page for that entry.
        if (selectedDateEntries != null && selectedDateEntries.Any())
        {
            var first = selectedDateEntries.First();
            Navigation.NavigateTo($"/journal/view/{first.Id}");
            return;
        }

        // No entry exists for that date — open the journal write page and pass the date so user can create an entry for it.
        var dateString = date.ToString("yyyy-MM-dd");
        Navigation.NavigateTo($"/journal?new=true&date={dateString}");
    }

    private async Task PreviousMonth()
    {
        currentDate = currentDate.AddMonths(-1);
        await LoadCalendarData();
    }

    private async Task NextMonth()
    {
        currentDate = currentDate.AddMonths(1);
        await LoadCalendarData();
    }

    private void ViewEntry(int id)
    {
        Navigation.NavigateTo($"/journal/{id}");
    }

    private async Task HandleKeyDown(DateTime date, KeyboardEventArgs e)
    {
        if (e.Key == "Enter" || e.Key == " " || e.Key == "Spacebar")
        {
            await SelectDate(date);
        }
    }
}
