@page "/editor"
@page "/editor/{EntryId:int}"
@using JournalApp.Services
@using JournalApp.Models
@using Microsoft.AspNetCore.Components.Forms
@inject JournalService JournalService
@inject NavigationManager Navigation

<div style="padding: 20px;">
    <h1>Journal Entry Editor</h1>

    <div style="margin-bottom: 20px;">
        <button @onclick="Cancel" style="padding: 10px 20px;">← Back</button>
        <button @onclick="SaveEntry" style="padding: 10px 20px; background: green; color: white;">Save</button>
    </div>

    <div style="margin-bottom: 15px;">
        <label><strong>Date:</strong></label><br />
        <input type="date" @bind="entryDate" style="width: 200px; padding: 5px;" />
    </div>

    <div style="margin-bottom: 15px;">
        <label><strong>Title:</strong></label><br />
        <input type="text" @bind="title" style="width: 100%; padding: 8px;" placeholder="Entry title..." />
    </div>

    <div style="margin-bottom: 15px;">
        <label><strong>Mood:</strong></label><br />
        <select @bind="mood" style="padding: 8px;">
            <option value="Happy">Happy</option>
            <option value="Sad">Sad</option>
            <option value="Angry">Angry</option>
            <option value="Anxious">Anxious</option>
            <option value="Excited">Excited</option>
            <option value="Calm">Calm</option>
        </select>
    </div>

    <div style="margin-bottom: 15px;">
        <label><strong>Content:</strong></label><br />
        <textarea @bind="content"
                  rows="15"
                  style="width: 100%; padding: 10px; font-size: 14px; font-family: Arial;"
                  placeholder="Write your thoughts here...">
        </textarea>
    </div>

    <div style="margin-bottom: 15px;">
        <label><strong>Tags (comma-separated):</strong></label><br />
        <input type="text" @bind="tags" style="width: 100%; padding: 8px;" placeholder="work, health, travel" />
    </div>

    @if (!string.IsNullOrEmpty(message))
    {
        <div style="padding: 15px; background: @(isError ? "#fee" : "#efe"); border: 1px solid @(isError ? "red" : "green"); margin: 10px 0;">
            @message
        </div>
    }
</div>

@code {
    [Parameter]
    public int? EntryId { get; set; }

    private DateTime entryDate = DateTime.Today;
    private string title = "";
    private string mood = "Happy";
    private string content = "";
    private string tags = "";
    private string message = "";
    private bool isError = false;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            if (EntryId.HasValue && EntryId.Value > 0)
            {
                var entry = await JournalService.GetEntryByIdAsync(EntryId.Value);
                if (entry != null)
                {
                    entryDate = entry.EntryDate;
                    title = entry.Title;
                    mood = entry.PrimaryMood ?? "Happy";
                    content = entry.Content;
                    tags = entry.Tags;
                }
            }
        }
        catch (Exception ex)
        {
            message = $"Error loading: {ex.Message}";
            isError = true;
        }
    }

    private async Task SaveEntry()
    {
        try
        {
            var entry = new JournalEntry
            {
                Id = EntryId ?? 0,
                EntryDate = entryDate,
                Title = title,
                Content = content,
                Tags = tags,
                CreatedAt = DateTime.Now,
                UpdatedAt = DateTime.Now,
                WordCount = string.IsNullOrWhiteSpace(content) ? 0 : content.Split(new[] { ' ', '\n', '\r', '\t' }, StringSplitOptions.RemoveEmptyEntries).Length
            };

            // store mood as string
            entry.PrimaryMood = mood;

            await JournalService.SaveEntryAsync(entry);
            message = "Entry saved successfully!";
            isError = false;

            await Task.Delay(800);
            Navigation.NavigateTo("/");
        }
        catch (Exception ex)
        {
            message = $"Error saving: {ex.Message}";
            isError = true;
        }
    }

    private void Cancel()
    {
        Navigation.NavigateTo("/");
    }
}