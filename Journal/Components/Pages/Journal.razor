@page "/journal"
@page "/journal/{EntryId:int}"
@using JournalApp.Services
@using JournalApp.Models
@using Microsoft.JSInterop
@inject IJSRuntime JS
@inject JournalService JournalService
@inject NavigationManager Navigation

<div class="journal-container">
    <header class="journal-header">
        <div>
            <h3 class="journal-title">üìì Daily Journal</h3>
            <p class="journal-subtitle">Capture your thoughts ‚Äî one day at a time.</p>
        </div>
        <div class="journal-actions">
            <button class="btn btn-outline-secondary btn-sm" @onclick="BackToEntries" disabled="@isSaving" aria-disabled="@isSaving">‚Üê Back to All Entries</button>
            <button class="btn btn-outline-primary btn-sm ms-2" @onclick="ExportEntry" disabled="@isSaving" aria-disabled="@isSaving">Export</button>
        </div>
    </header>

    <main class="journal-main">
        @if (entry == null)
        {
            <section class="empty-state p-4">
                <p class="text-muted">No entry for today.</p>
                <button class="btn btn-primary mt-2" @onclick="CreateEntry">Start Writing</button>
            </section>
        }
        else
        {
            <article class="card journal-card">
                <header class="card-header card-header-custom">
                    <div>
                        <strong>@entry.Date.ToString("dddd, MMMM dd, yyyy")</strong>
                        @if (entry.UpdatedAt != default)
                        {
                            <small class="muted d-block">Last saved: @entry.UpdatedAt.ToString("g")</small>
                        }
                    </div>
                </header>

                <section class="card-body">
                    <!-- Title -->
                    <div class="mb-3">
                        <label class="form-label">Title</label>
                        <input type="text" class="form-control" @bind="entry.Title" placeholder="Enter a title for your entry" maxlength="200" aria-label="Entry title" />
                    </div>

                    <!-- Mood -->
                    <div class="mb-3">
                        <label class="form-label">How are you feeling today?</label>
                        <select class="form-select" @bind="entry.PrimaryMood" aria-label="Primary mood">
                            <option value="">‚Äî Select ‚Äî</option>
                            <option value="Happy">üòä Happy</option>
                            <option value="Excited">üéâ Excited</option>
                            <option value="Grateful">üôè Grateful</option>
                            <option value="Confident">üí™ Confident</option>
                            <option value="Relaxed">üòå Relaxed</option>
                            <option value="Calm">üßò Calm</option>
                            <option value="Thoughtful">ü§î Thoughtful</option>
                            <option value="Curious">üßê Curious</option>
                            <option value="Nostalgic">üí≠ Nostalgic</option>
                            <option value="Bored">üòë Bored</option>
                            <option value="Sad">üò¢ Sad</option>
                            <option value="Angry">üò† Angry</option>
                            <option value="Stressed">üòü Stressed</option>
                            <option value="Anxious">üò∞ Anxious</option>
                            <option value="Lonely">üòî Lonely</option>
                            <option value="Tired">üò¥ Tired</option>
                        </select>

                        <div class="mt-2">
                            <label class="form-label">Secondary Moods (optional, up to 2)</label>
                            <div class="d-flex gap-2 flex-wrap">
                                <select class="form-select" @bind="secondary1" aria-label="Secondary mood 1">
                                    <option value="">Select</option>
                                    @foreach (var m in SecondaryMoodOptions)
                                    {
                                        <option value="@m">@m</option>
                                    }
                                </select>
                                <select class="form-select" @bind="secondary2" aria-label="Secondary mood 2">
                                    <option value="">Select</option>
                                    @foreach (var m in SecondaryMoodOptions)
                                    {
                                        <option value="@m">@m</option>
                                    }
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Content with Quill Editor -->
                    <div class="mb-3">
                        <label class="form-label">Your thoughts for today</label>
                        <div id="quill-editor" role="textbox" aria-multiline="true" aria-label="Journal editor" class="quill-container"></div>
                    </div>

                    <!-- Tags -->
                    <div class="mb-3">
                        <label class="form-label">Tags (comma-separated)</label>
                        <input type="text" class="form-control"
                               @bind="entry.Tags"
                               placeholder="e.g., work, family, gratitude" aria-label="Tags" />
                    </div>

                    <!-- Actions -->
                    <div class="d-flex justify-content-end gap-2 action-row">
                        @if (isEditing)
                        {
                            <button class="btn btn-outline-danger" @onclick="Delete" disabled="@isSaving" aria-disabled="@isSaving">Delete</button>
                        }
                        <button class="btn btn-outline-secondary" @onclick="BackToEntries" disabled="@isSaving" aria-disabled="@isSaving">Cancel</button>
                        <button class="btn btn-success" @onclick="Save" disabled="@isSaving" aria-disabled="@isSaving">
                            @(isSaving ? "Saving..." : "Save")
                        </button>
                    </div>
                </section>
            </article>

            @if (!string.IsNullOrEmpty(statusMessage))
            {
                <div class="alert alert-info mt-3" role="status" aria-live="polite">@statusMessage</div>
            }
        }
    </main>
</div>

@if (!string.IsNullOrEmpty(errorMessage))
{
    <div class="alert alert-danger toast toast-error" role="alert" @onclick="ClearError" aria-live="assertive">
        <div class="toast-body">
            @errorMessage
            <button type="button" class="btn-close" @onclick="ClearError" aria-label="Close"></button>
        </div>
    </div>
}

@if (!string.IsNullOrEmpty(successMessage))
{
    <div class="alert alert-success toast toast-success" role="status" @onclick="ClearSuccess" aria-live="polite">
        <div class="toast-body">
            @successMessage
            <button type="button" class="btn-close" @onclick="ClearSuccess" aria-label="Close"></button>
        </div>
    </div>
}

@code {
    [Parameter]
    public int? EntryId { get; set; }

    private JournalEntry? entry;
    private string errorMessage = "";
    private string successMessage = "";
    private string statusMessage = "";
    private bool isInitialized = false;
    private bool isSaving = false;

    private string secondary1 = "";
    private string secondary2 = "";

    private bool forceNew = false;
    private bool isEditing = false; // true when editing an existing entry

    private static readonly string[] SecondaryMoodOptions = new[] { "Happy", "Excited", "Relaxed", "Grateful", "Confident", "Calm", "Thoughtful", "Curious", "Nostalgic", "Bored", "Sad", "Angry", "Stressed", "Lonely", "Anxious", "Tired" };

    protected override async Task OnInitializedAsync()
    {
        // Detect query parameter ?new=true
        try
        {
            var uri = Navigation.ToAbsoluteUri(Navigation.Uri);
            if (!string.IsNullOrEmpty(uri.Query) && uri.Query.Contains("new=true", StringComparison.OrdinalIgnoreCase))
            {
                forceNew = true;
            }
        }
        catch { }

        await LoadEntry();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && entry != null)
        {
            try
            {
                await Task.Delay(100);
                await JS.InvokeVoidAsync("initQuillEditor", "quill-editor");

                // Only set content when editing an existing entry
                if (isEditing && !string.IsNullOrWhiteSpace(entry.Content))
                {
                    await JS.InvokeVoidAsync("setQuillContent", entry.Content);
                }

                isInitialized = true;
            }
            catch (Exception ex)
            {
                errorMessage = $"Editor initialization failed: {ex.Message}";
                Console.WriteLine($"Quill init error: {ex}");
            }
        }
    }

    private async Task LoadEntry()
    {
        try
        {
            if (EntryId.HasValue && EntryId.Value > 0)
            {
                // Load existing entry for editing
                entry = await JournalService.GetEntryAsync(EntryId.Value);
                if (entry == null)
                {
                    errorMessage = "Entry not found.";
                }
                else
                {
                    isEditing = true;
                    // populate secondary moods when editing
                    if (!string.IsNullOrWhiteSpace(entry.SecondaryMoods))
                    {
                        var parts = entry.SecondaryMoods.Split(',', StringSplitOptions.RemoveEmptyEntries).Select(s => s.Trim()).ToArray();
                        if (parts.Length > 0) secondary1 = parts[0];
                        if (parts.Length > 1) secondary2 = parts[1];
                    }
                }
            }
            else if (forceNew)
            {
                // Explicit new entry requested ‚Äî start with a blank entry
                entry = new JournalEntry
                {
                    Date = DateTime.Today,
                    CreatedAt = DateTime.Now,
                    UpdatedAt = DateTime.Now
                };
                secondary1 = "";
                secondary2 = "";
                isEditing = false;
                statusMessage = "Creating new entry.";
            }
            else
            {
                // Default behavior: start with a blank form for new entry.
                entry = new JournalEntry
                {
                    Date = DateTime.Today,
                    CreatedAt = DateTime.Now,
                    UpdatedAt = DateTime.Now
                };
                secondary1 = "";
                secondary2 = "";
                isEditing = false;
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Error loading entry: {ex.Message}";
            Console.WriteLine($"LoadEntry error: {ex}");
        }
    }

    private void CreateEntry()
    {
        entry = new JournalEntry
        {
            Date = DateTime.Today,
            CreatedAt = DateTime.Now,
            UpdatedAt = DateTime.Now
        };
        secondary1 = "";
        secondary2 = "";
        isEditing = false;
        statusMessage = "Creating new entry.";
        StateHasChanged();
    }

    private async Task Save()
    {
        try
        {
            errorMessage = "";
            successMessage = "";
            statusMessage = "";

            if (entry == null) return;

            // Validate
            if (string.IsNullOrWhiteSpace(entry.Title))
            {
                errorMessage = "Please enter a title.";
                return;
            }

            if (string.IsNullOrWhiteSpace(entry.PrimaryMood))
            {
                errorMessage = "Please select your mood.";
                return;
            }

            isSaving = true;

            // Get content from Quill editor
            if (isInitialized)
            {
                try
                {
                    entry.Content = await JS.InvokeAsync<string>("getQuillContent");
                }
                catch (Exception ex)
                {
                    errorMessage = $"Failed to get editor content: {ex.Message}";
                    return;
                }
            }

            if (string.IsNullOrWhiteSpace(entry.Content))
            {
                errorMessage = "Please write some content.";
                return;
            }

            // Set secondary moods
            var sec = new[] { secondary1, secondary2 }.Where(s => !string.IsNullOrWhiteSpace(s)).ToArray();
            entry.SecondaryMoods = string.Join(",", sec);

            // Set category based on mood
            entry.Category = GetMoodCategory(entry.PrimaryMood);

            // Determine whether save will update an existing entry for the date
            var existingForDate = await JournalService.GetEntryByDateAsync(entry.Date == default ? DateTime.Today : entry.Date);
            var willUpdate = existingForDate != null && existingForDate.Id != entry.Id;

            // Save
            var result = await JournalService.SaveEntryAsync(entry);

            if (result > 0)
            {
                successMessage = willUpdate || isEditing ? "Entry updated successfully!" : "Entry created successfully!";
                statusMessage = willUpdate || isEditing ? "Updated existing entry." : "Created new entry.";

                if (!string.IsNullOrWhiteSpace(entry.SecondaryMoods))
                {
                    statusMessage += $" Secondary moods: {entry.SecondaryMoods}.";
                }

                await Task.Delay(900);
                Navigation.NavigateTo("/entries");
            }
            else
            {
                errorMessage = "Failed to save entry.";
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Error saving entry: {ex.Message}";
            Console.WriteLine($"Save error: {ex}");
        }
        finally
        {
            isSaving = false;
        }
    }

    private async Task Delete()
    {
        try
        {
            if (entry == null || entry.Id == 0) return;

            var confirmed = await JS.InvokeAsync<bool>("confirm", "Are you sure you want to delete this entry?");

            if (confirmed)
            {
                isSaving = true;
                await JournalService.DeleteEntryAsync(entry);
                successMessage = "Entry deleted successfully!";
                await Task.Delay(800);
                Navigation.NavigateTo("/entries");
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Error deleting entry: {ex.Message}";
        }
        finally
        {
            isSaving = false;
        }
    }

    private void BackToEntries()
    {
        if (!isSaving)
            Navigation.NavigateTo("/entries");
    }

    private void ClearError()
    {
        errorMessage = "";
    }

    private void ClearSuccess()
    {
        successMessage = "";
    }

    private string GetMoodCategory(string mood)
    {
        var positive = new[] { "Happy", "Excited", "Relaxed", "Grateful", "Confident" };
        var neutral = new[] { "Calm", "Thoughtful", "Curious", "Nostalgic", "Bored" };
        var negative = new[] { "Sad", "Angry", "Stressed", "Lonely", "Anxious", "Tired" };

        if (positive.Contains(mood)) return "Positive";
        if (neutral.Contains(mood)) return "Neutral";
        if (negative.Contains(mood)) return "Negative";
        return "";
    }

    private async Task ExportEntry()
    {
        try
        {
            if (entry == null) return;

            // Build simple HTML export
            var html = $"<html><head><meta charset=\"utf-8\"><title>{System.Net.WebUtility.HtmlEncode(entry.Title)}</title></head><body>" +
                       $"<h1>{System.Net.WebUtility.HtmlEncode(entry.Title)}</h1>" +
                       $"<p><em>{entry.Date:dddd, MMMM dd, yyyy}</em></p>" +
                       $"<p><strong>Mood:</strong> {System.Net.WebUtility.HtmlEncode(entry.PrimaryMood)}" +
                       (!string.IsNullOrWhiteSpace(entry.SecondaryMoods) ? $" (Secondary: {System.Net.WebUtility.HtmlEncode(entry.SecondaryMoods)})" : "") +
                       $"</p>" +
                       $"<hr/>" +
                       entry.Content +
                       $"</body></html>";

            var filename = $"journal-{entry.Date:yyyy-MM-dd}.html";
            await JS.InvokeVoidAsync("downloadFile", filename, html, "text/html");
        }
        catch (Exception ex)
        {
            errorMessage = $"Export failed: {ex.Message}";
        }
    }
}
<style>
    /* Layout */
    .journal-container {
        max-width: 980px;
        margin: 1.5rem auto;
        padding: 1rem;
    }

    .journal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 1rem;
        margin-bottom: 1rem;
        padding: 0.75rem 1rem;
        border-radius: 10px;
        background: linear-gradient(90deg, #ffffff 0%, #f7fbff 100%);
        box-shadow: 0 4px 10px rgba(22, 33, 62, 0.04);
        border: 1px solid rgba(0,0,0,0.04);
    }

    .journal-title {
        margin: 0;
        font-size: 1.25rem;
    }

    .journal-subtitle {
        margin: 0;
        font-size: 0.9rem;
        color: #6c757d;
    }

    .journal-actions button {
        min-width: 90px;
    }

    .journal-main {
        margin-top: 0.75rem;
    }

    .empty-state {
        border: 1px dashed #e0e6ef;
        border-radius: 8px;
        background: linear-gradient(180deg, #ffffff, #fbfdff);
        text-align: center;
    }

    .journal-card {
        border-radius: 10px;
        overflow: hidden;
        border: 1px solid rgba(22, 33, 62, 0.06);
        box-shadow: 0 6px 18px rgba(22, 33, 62, 0.04);
    }

    .card-header-custom {
        background: linear-gradient(90deg,#f8f9fb,#ffffff);
        padding: 1rem 1.25rem;
        border-bottom: 1px solid rgba(0,0,0,0.03);
    }

    .muted {
        color: #6c757d;
        font-size: 0.85rem;
    }

    /* Editor */
    .quill-container {
        height: 320px;
        background: #ffffff;
        border: 1px solid #dee2e6;
        border-radius: 0.375rem;
        overflow: hidden;
    }

    :global(.ql-toolbar) {
        border-top-left-radius: 0.375rem;
        border-top-right-radius: 0.375rem;
        background: #fbfdff;
        border-bottom: 1px solid #eceef1;
    }

    :global(.ql-container) {
        border-bottom-left-radius: 0.375rem;
        border-bottom-right-radius: 0.375rem;
    }

    /* Actions */
    .action-row .btn {
        min-width: 84px;
    }

    /* Toasts / alerts */
    .toast {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 1200;
        min-width: 260px;
        border-radius: 8px;
        box-shadow: 0 8px 30px rgba(0,0,0,0.08);
    }

    .toast .toast-body {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 0.75rem;
        padding: 0.8rem 1rem;
    }

    .toast .btn-close {
        background: transparent;
        border: none;
    }

    .toast-error {
        border-left: 4px solid #d9534f;
    }

    .toast-success {
        border-left: 4px solid #28a745;
    }

    /* Responsive tweaks */
    @media (max-width: 720px) {
        .journal-header {
            flex-direction: column;
            align-items: flex-start;
        }

        .journal-actions {
            margin-top: 0.5rem;
            width: 100%;
            display: flex;
            justify-content: flex-end;
            gap: 0.5rem;
        }

        .action-row {
            flex-direction: column-reverse;
            align-items: stretch;
        }

        .action-row .btn {
            width: 100%;
        }
    }
</style>
