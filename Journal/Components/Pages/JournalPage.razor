@page "/journal"
@inject IJournalService JournalService

<PageTitle>My Journal</PageTitle>

<h1>My Journal</h1>

<div class="journal-container mt-4">
    <h3>New Entry - @(DateTime.Today.ToString("MMMM dd, yyyy"))</h3>
    
    <div class="mt-3">
        <MoodSelector PrimaryMood="@currentEntry.PrimaryMood"
                      PrimaryMoodChanged="@OnPrimaryMoodChanged"
                      SecondaryMood1="@currentEntry.SecondaryMood1"
                      SecondaryMood1Changed="@OnSecondaryMood1Changed"
                      SecondaryMood2="@currentEntry.SecondaryMood2"
                      SecondaryMood2Changed="@OnSecondaryMood2Changed" />
    </div>
    
    <div class="mt-3">
        <label>Journal Entry</label>
        <textarea class="form-control" 
                  rows="10"
                  placeholder="Write your journal here..."
                  @bind="currentEntry.Content">
        </textarea>
    </div>
    
    <div class="mt-3">
        <TagSelector Tags="@currentEntry.TagList"
                     TagsChanged="@OnTagsChanged" />
    </div>
    
    <button class="btn btn-primary mt-3" @onclick="SaveEntry">Save Entry</button>
    
    @if (savedMessage)
    {
        <div class="alert alert-success mt-3">Entry saved successfully!</div>
    }
</div>

@code {
    private JournalEntry currentEntry = new() { EntryDate = DateTime.Today };
    private bool savedMessage = false;
    
    protected override async Task OnInitializedAsync()
    {
        var existing = await JournalService.GetEntryByDateAsync(DateTime.Today);
        if (existing != null)
        {
            currentEntry = existing;
        }
    }
    
    private void OnPrimaryMoodChanged(MoodType value)
    {
        currentEntry.PrimaryMood = value;
    }
    
    private void OnSecondaryMood1Changed(MoodType? value)
    {
        currentEntry.SecondaryMood1 = value;
    }
    
    private void OnSecondaryMood2Changed(MoodType? value)
    {
        currentEntry.SecondaryMood2 = value;
    }
    
    private void OnTagsChanged(List<string> value)
    {
        currentEntry.TagList = value;
    }
    
    private async Task SaveEntry()
    {
        try
        {
            await JournalService.SaveEntryAsync(currentEntry);
            savedMessage = true;
            StateHasChanged();
            
            // Hide message after 3 seconds
            await Task.Delay(3000);
            savedMessage = false;
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error saving entry: {ex.Message}");
        }
    }
}