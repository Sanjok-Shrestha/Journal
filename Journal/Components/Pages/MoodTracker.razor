@page "/mood-tracker"
@using JournalApp.Services
@using JournalApp.Models
@inject JournalService JournalService
@inject MoodService MoodService

<div class="mood-tracker container mt-4" style="max-width: 1100px;">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="display-6">Mood Tracker</h1>
            <p class="text-muted">Detailed breakdown of moods across your journal entries.</p>
        </div>
        <div class="d-flex align-items-center gap-2">
            <select class="form-select" style="width: 220px; display: inline-block;" @bind="selectedRange">
                <option value="30">Last 30 days</option>
                <option value="90">Last 90 days</option>
                <option value="365">Last 365 days</option>
                <option value="all">All time</option>
            </select>
            <button class="btn btn-outline-primary ms-2" @onclick="Refresh" disabled="@isLoading">
                @(isLoading ? "Refreshing..." : "Refresh")
            </button>
        </div>
    </div>

    @if (isLoading)
    {
        <div class="text-center py-4 text-muted">Loading mood dataâ€¦</div>
    }
    else if (!string.IsNullOrEmpty(errorMessage))
    {
        <div class="alert alert-danger">@errorMessage</div>
    }
    else
    {
        <div class="row g-4">
            <div class="col-lg-4">
                <div class="card shadow-sm p-3">
                    <h5>Total Entries</h5>
                    <div class="display-6 fw-bold">@totalEntries</div>
                    <p class="text-muted">Entries in selected range</p>
                </div>

                <div class="card shadow-sm p-3 mt-3">
                    <h5>Unique Moods</h5>
                    <div class="display-6 fw-bold">@uniqueMoodCount</div>
                    <p class="text-muted">Distinct primary moods used</p>
                </div>

                <div class="card shadow-sm p-3 mt-3">
                    <h5>Top Tags</h5>
                    <div>
                        @if (!topTags.Any())
                        {
                            <div class="text-muted">No tags yet</div>
                        }
                        else
                        {
                            @foreach (var t in topTags.Take(8))
                            {
                                <span class="badge bg-secondary me-1 mb-1">@t.Key (@t.Value)</span>
                            }
                        }
                    </div>
                </div>
            </div>

            <div class="col-lg-8">
                <div class="card shadow-sm p-3">
                    <h5>Mood Distribution</h5>
                    <div class="mood-distribution mt-3">
                        @if (!moodCounts.Any())
                        {
                            <div class="text-muted">No mood data in this range.</div>
                        }
                        else
                        {
                            @foreach (var kv in moodCounts.OrderByDescending(k => k.Value))
                            {
                                <div class="d-flex align-items-center mb-2" @key="kv.Key">
                                    <div style="width: 160px;">@kv.Key</div>
                                    <div class="progress flex-grow-1 me-2" style="height: 18px; background: #f1f3f5;">
                                        <div class="progress-bar bg-primary" role="progressbar"
                                             style="width: @(GetPercentage(kv.Value))%"
                                             aria-valuenow="@Math.Round(GetPercentage(kv.Value))"
                                             aria-valuemin="0" aria-valuemax="100"></div>
                                    </div>
                                    <div style="width: 68px; text-align: right;">@kv.Value (@GetPercentageLabel(kv.Value))</div>
                                </div>
                            }
                        }
                    </div>
                </div>

                <div class="card shadow-sm p-3 mt-3">
                    <h5>Secondary Moods Breakdown</h5>
                    <div class="secondary-list mt-3">
                        @if (!secondaryCounts.Any())
                        {
                            <div class="text-muted">No secondary moods recorded.</div>
                        }
                        else
                        {
                            @foreach (var kv in secondaryCounts.OrderByDescending(k => k.Value))
                            {
                                <div class="mb-2 d-flex justify-content-between" @key="kv.Key">
                                    <div>@kv.Key</div>
                                    <div class="text-muted">@kv.Value</div>
                                </div>
                            }
                        }
                    </div>
                </div>

                <div class="card shadow-sm p-3 mt-3">
                    <h5>Mood by Tag</h5>
                    <div class="mt-2">
                        @if (!tagMoodCounts.Any())
                        {
                            <div class="text-muted">No tag-based mood analysis yet.</div>
                        }
                        else
                        {
                            @foreach (var kv in tagMoodCounts.OrderByDescending(k => k.Value.Values.Sum()))
                            {
                                <div class="mb-2" @key="kv.Key">
                                    <strong>@kv.Key</strong>
                                    <div class="d-flex gap-2 mt-1">
                                        @foreach (var t in kv.Value.OrderByDescending(x => x.Value).Take(3))
                                        {
                                            <div class="badge bg-info text-dark">@t.Key (@t.Value)</div>
                                        }
                                    </div>
                                </div>
                            }
                        }
                    </div>
                </div>
            </div>
        </div>
    }
</div>

@code {
    private int totalEntries = 0;
    private int uniqueMoodCount = 0;

    private Dictionary<string, int> moodCounts = new(StringComparer.OrdinalIgnoreCase);
    private Dictionary<string, int> secondaryCounts = new(StringComparer.OrdinalIgnoreCase);
    private Dictionary<string, Dictionary<string, int>> tagMoodCounts = new(StringComparer.OrdinalIgnoreCase);
    private List<KeyValuePair<string, int>> topTags = new();

    private string selectedRange = "90"; // days or 'all'
    private bool isLoading = false;
    private string? errorMessage;

    protected override async Task OnInitializedAsync()
    {
        await Load();
    }

    private async Task Load()
    {
        isLoading = true;
        errorMessage = null;

        try
        {
            var entries = await JournalService.GetEntriesAsync() ?? new List<JournalEntry>();

            // determine range filter
            IEnumerable<JournalEntry> rangeEntries = entries;
            if (!string.Equals(selectedRange, "all", StringComparison.OrdinalIgnoreCase))
            {
                if (int.TryParse(selectedRange, out var days) && days > 0)
                {
                    var cutoff = DateTime.Today.AddDays(-days + 1); // inclusive last N days
                    rangeEntries = entries.Where(e => e.Date.Date >= cutoff);
                }
            }

            var list = rangeEntries
                .Select(e =>
                {
                    // normalize date to local date for range comparisons and grouping
                    e.Date = e.Date.ToLocalTime();
                    return e;
                })
                .ToList();

            totalEntries = list.Count;

            // reset dictionaries
            moodCounts = new Dictionary<string, int>(StringComparer.OrdinalIgnoreCase);
            secondaryCounts = new Dictionary<string, int>(StringComparer.OrdinalIgnoreCase);
            tagMoodCounts = new Dictionary<string, Dictionary<string, int>>(StringComparer.OrdinalIgnoreCase);

            // primary moods (use GroupBy for efficiency)
            moodCounts = list
                .Where(e => !string.IsNullOrWhiteSpace(e.PrimaryMood))
                .GroupBy(e => e.PrimaryMood!.Trim(), StringComparer.OrdinalIgnoreCase)
                .ToDictionary(g => g.Key, g => g.Count(), StringComparer.OrdinalIgnoreCase);

            // secondary moods
            foreach (var e in list)
            {
                if (string.IsNullOrWhiteSpace(e.SecondaryMoods)) continue;
                foreach (var s in e.SecondaryMoods.Split(',', StringSplitOptions.RemoveEmptyEntries)
                                                .Select(x => x.Trim())
                                                .Where(x => !string.IsNullOrEmpty(x)))
                {
                    if (!secondaryCounts.ContainsKey(s)) secondaryCounts[s] = 0;
                    secondaryCounts[s]++;
                }
            }

            // tags -> mood mapping
            foreach (var e in list)
            {
                if (string.IsNullOrWhiteSpace(e.Tags) || string.IsNullOrWhiteSpace(e.PrimaryMood)) continue;

                var primary = e.PrimaryMood.Trim();
                foreach (var t in e.Tags.Split(',', StringSplitOptions.RemoveEmptyEntries)
                                         .Select(x => x.Trim())
                                         .Where(x => !string.IsNullOrEmpty(x)))
                {
                    if (!tagMoodCounts.TryGetValue(t, out var map))
                    {
                        map = new Dictionary<string, int>(StringComparer.OrdinalIgnoreCase);
                        tagMoodCounts[t] = map;
                    }

                    if (!map.ContainsKey(primary)) map[primary] = 0;
                    map[primary]++;
                }
            }

            uniqueMoodCount = moodCounts.Keys.Count;

            // top tags
            var tagCounts = list
                .Where(e => !string.IsNullOrWhiteSpace(e.Tags))
                .SelectMany(e => e.Tags!.Split(',', StringSplitOptions.RemoveEmptyEntries)
                    .Select(t => t.Trim()))
                .Where(t => !string.IsNullOrEmpty(t))
                .GroupBy(t => t, StringComparer.OrdinalIgnoreCase)
                .Select(g => new KeyValuePair<string, int>(g.Key, g.Count()))
                .OrderByDescending(kv => kv.Value)
                .ToList();

            topTags = tagCounts;
        }
        catch (Exception ex)
        {
            errorMessage = "Unable to load mood tracker data.";
            Console.WriteLine($"MoodTracker.Load error: {ex}");
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task Refresh()
    {
        await Load();
    }

    private double GetPercentage(int count)
    {
        if (totalEntries == 0) return 0;
        // return percent value 0..100 (one decimal place in label)
        return Math.Round((double)count / totalEntries * 100, 1);
    }

    private string GetPercentageLabel(int count)
    {
        var pct = GetPercentage(count);
        return pct % 1 == 0 ? $"{(int)pct}%" : $"{pct}%";
    }
}
<style>
.mood-tracker .card { border-radius: 10px; }
.mood-tracker .badge { font-size: 0.85rem; padding: 0.45rem 0.6rem; border-radius: 6px; }
.mood-distribution .progress { background: #f1f3f5; border-radius: 6px; overflow: hidden; }
.mood-distribution .progress-bar { transition: width 420ms cubic-bezier(.2,.8,.2,1); background: linear-gradient(90deg,#60a5fa,#3b82f6); }
.secondary-list .mb-2 { border-bottom: 1px dashed rgba(0,0,0,0.03); padding-bottom: 0.4rem; }
@media (max-width: 992px) {
    .mood-tracker .display-6 { font-size: 1.5rem; }
    .mood-tracker .card { margin-bottom: 0.75rem; }
}
</style>
