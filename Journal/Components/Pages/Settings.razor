@page "/settings"
@inject IAuthenticationService AuthService
@inject ThemeService ThemeService
@inject IJournalService JournalService
@inject IPdfExportService PdfExportService
@inject NavigationManager Navigation
@inject IJSRuntime JS

<div class="settings-container">
    <h1> Settings</h1>

    @if (saveMessage != null)
    {
        <div class="alert alert-success">@saveMessage</div>
    }

    <div class="settings-section">
        <h2>Theme Customization</h2>
        <div class="theme-selector">
            <button class="theme-option @(ThemeService.CurrentTheme == "Light" ? "active" : "")" 
                    @onclick='() => ChangeTheme("Light")'>
                <div class="theme-preview light-preview"></div>
                <span> Light</span>
            </button>
            <button class="theme-option @(ThemeService.CurrentTheme == "Dark" ? "active" : "")" 
                    @onclick='() => ChangeTheme("Dark")'>
                <div class="theme-preview dark-preview"></div>
                <span> Dark</span>
            </button>
        </div>
    </div>

    <div class="settings-section">
        <h2> Security & Privacy</h2>
        
        <div class="form-group">
            <h3>Change Password</h3>
            <input type="password" 
                   @bind="currentPassword" 
                   class="form-control" 
                   placeholder="Current Password" />
            <input type="password" 
                   @bind="newPassword" 
                   class="form-control mt-2" 
                   placeholder="New Password (min 6 characters)" />
            <input type="password" 
                   @bind="confirmNewPassword" 
                   class="form-control mt-2" 
                   placeholder="Confirm New Password" />
            <button class="btn btn-primary mt-2" @onclick="ChangePassword">
                 Change Password
            </button>
        </div>

        <div class="form-group mt-4">
            <h3>PIN Lock</h3>
            
            @if (hasPin)
            {
                <div class="alert alert-info">
                     PIN is currently <strong>enabled</strong>
                </div>
                
                <div class="pin-actions">
                    <input type="password" 
                           @bind="newPin" 
                           class="form-control" 
                           placeholder="Enter new 4-digit PIN" 
                           maxlength="4"
                           inputmode="numeric" />
                    <button class="btn btn-primary mt-2" @onclick="UpdatePin">
                         Update PIN
                    </button>
                    <button class="btn btn-danger mt-2" @onclick="RemovePin">
                         Remove PIN
                    </button>
                </div>
            }
            else
            {
                <div class="alert alert-warning">
                     PIN is currently <strong>disabled</strong>
                </div>
                
                <input type="password" 
                       @bind="newPin" 
                       class="form-control" 
                       placeholder="Enter 4-digit PIN" 
                       maxlength="4"
                       inputmode="numeric" />
                <small class="text-muted">Set a PIN for quick access to your journal</small>
                <button class="btn btn-success mt-2" @onclick="SetPin">
                     Enable PIN
                </button>
            }
        </div>

        <div class="form-group mt-4">
            <button class="btn btn-danger" @onclick="Logout">
                 Logout
            </button>
        </div>
    </div>

    <div class="settings-section">
        <h2>Export Journal</h2>
        <p>Export your journal entries as PDF</p>
        
        <div class="export-controls">
            <div class="form-group">
                <label>Start Date</label>
                <input type="date" @bind="exportStartDate" class="form-control" />
            </div>
            <div class="form-group">
                <label>End Date</label>
                <input type="date" @bind="exportEndDate" class="form-control" />
            </div>
            <button class="btn btn-primary" @onclick="ExportToPdf" disabled="@isExporting">
                @if (isExporting)
                {
                    <span>Exporting...</span>
                }
                else
                {
                    <span> Export to PDF</span>
                }
            </button>
        </div>
    </div>

    <div class="settings-section">
        <h2>Account Information</h2>
        @if (currentUser != null)
        {
            <p><strong>Username:</strong> @currentUser.Username</p>
            <p><strong>Member Since:</strong> @currentUser.CreatedAt.ToString("MMMM dd, yyyy")</p>
        }
    </div>
</div>

@code {
    private User? currentUser;
    private string currentPassword = string.Empty;
    private string newPassword = string.Empty;
    private string confirmNewPassword = string.Empty;
    private string newPin = string.Empty;
    private DateTime exportStartDate = DateTime.Today.AddMonths(-1);
    private DateTime exportEndDate = DateTime.Today;
    private bool isExporting = false;
    private string? saveMessage;
    private bool hasPin = false;

    protected override async Task OnInitializedAsync()
    {
        if (!await AuthService.IsAuthenticatedAsync())
        {
            Navigation.NavigateTo("/login");
            return;
        }

        currentUser = await AuthService.GetCurrentUserAsync();
        hasPin = await AuthService.HasPinAsync();
    }

    private void ChangeTheme(string theme)
    {
        ThemeService.SetTheme(theme);
        saveMessage = $"Theme changed to {theme}";
        StateHasChanged();
        
        Task.Delay(3000).ContinueWith(_ =>
        {
            saveMessage = null;
            InvokeAsync(StateHasChanged);
        });
    }

    private async Task ChangePassword()
    {
        if (string.IsNullOrWhiteSpace(currentPassword) || string.IsNullOrWhiteSpace(newPassword))
        {
            await JS.InvokeVoidAsync("alert", "Please fill in all password fields");
            return;
        }

        if (newPassword.Length < 6)
        {
            await JS.InvokeVoidAsync("alert", "New password must be at least 6 characters");
            return;
        }

        if (newPassword != confirmNewPassword)
        {
            await JS.InvokeVoidAsync("alert", "Passwords do not match");
            return;
        }

        var success = await AuthService.ChangePasswordAsync(currentPassword, newPassword);
        
        if (success)
        {
            await JS.InvokeVoidAsync("alert", "Password changed successfully!");
            currentPassword = string.Empty;
            newPassword = string.Empty;
            confirmNewPassword = string.Empty;
        }
        else
        {
            await JS.InvokeVoidAsync("alert", "Failed to change password. Check your current password.");
        }
    }

    private async Task SetPin()
    {
        if (string.IsNullOrWhiteSpace(newPin) || newPin.Length != 4)
        {
            await JS.InvokeVoidAsync("alert", "PIN must be exactly 4 digits");
            return;
        }

        if (!int.TryParse(newPin, out _))
        {
            await JS.InvokeVoidAsync("alert", "PIN must contain only numbers");
            return;
        }

        var success = await AuthService.SetPinAsync(newPin);
        
        if (success)
        {
            hasPin = true;
            newPin = string.Empty;
            await JS.InvokeVoidAsync("alert", "PIN enabled successfully!");
        }
        else
        {
            await JS.InvokeVoidAsync("alert", "Failed to set PIN");
        }
    }

    private async Task UpdatePin()
    {
        if (string.IsNullOrWhiteSpace(newPin) || newPin.Length != 4)
        {
            await JS.InvokeVoidAsync("alert", "PIN must be exactly 4 digits");
            return;
        }

        if (!int.TryParse(newPin, out _))
        {
            await JS.InvokeVoidAsync("alert", "PIN must contain only numbers");
            return;
        }

        var success = await AuthService.SetPinAsync(newPin);
        
        if (success)
        {
            newPin = string.Empty;
            await JS.InvokeVoidAsync("alert", "PIN updated successfully!");
        }
        else
        {
            await JS.InvokeVoidAsync("alert", "Failed to update PIN");
        }
    }

    private async Task RemovePin()
    {
        var confirmed = await JS.InvokeAsync<bool>("confirm", "Are you sure you want to remove your PIN?");
        
        if (confirmed)
        {
            var success = await AuthService.RemovePinAsync();
            
            if (success)
            {
                hasPin = false;
                await JS.InvokeVoidAsync("alert", "PIN removed successfully");
            }
            else
            {
                await JS.InvokeVoidAsync("alert", "Failed to remove PIN");
            }
        }
    }

    private async Task ExportToPdf()
    {
        isExporting = true;

        try
        {
            var entries = await JournalService.FilterEntriesAsync(
                exportStartDate, 
                exportEndDate, 
                null, 
                null
            );

            if (!entries.Any())
            {
                await JS.InvokeVoidAsync("alert", "No entries found in the selected date range");
                return;
            }

            var filePath = await PdfExportService.ExportToPdfAsync(entries, exportStartDate, exportEndDate);
            
            await Launcher.OpenAsync(new OpenFileRequest
            {
                File = new ReadOnlyFile(filePath)
            });

            saveMessage = $"Successfully exported {entries.Count} entries to PDF!";
        }
        catch (Exception ex)
        {
            await JS.InvokeVoidAsync("alert", $"Error exporting PDF: {ex.Message}");
        }
        finally
        {
            isExporting = false;
        }
    }

    private async Task Logout()
    {
        await AuthService.LogoutAsync();
        Navigation.NavigateTo("/login");
    }
}