@page "/tags"
@using TagModel = JournalApp.Models.Tag
@using JournalApp.Services
@using Microsoft.AspNetCore.Components
@inject TagService TagService

<div class="container py-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h1 class="h4">Tags</h1>
        <button class="btn btn-primary" @onclick="CreateNew" disabled="@isBusy">+ New Tag</button>
    </div>

    <div class="row">
        <div class="col-md-7 mb-4">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">All Tags</h5>

                    <div class="mb-2 d-flex gap-2 align-items-center">
                        <input class="form-control form-control-sm" placeholder="Search tags..." @bind="search" @bind:event="oninput" />
                        <button class="btn btn-sm btn-outline-secondary" @onclick="ClearSearch" title="Clear search">✕</button>
                    </div>

                    @if (isBusy)
                    {
                        <div class="text-center py-4 text-muted">Loading tags…</div>
                    }
                    else if (!FilteredTags.Any())
                    {
                        <div class="text-center py-4 text-muted">No tags found.</div>
                    }
                    else
                    {
                        <TagList Tags="FilteredTags"
                                 OnEdit="HandleEdit"
                                 OnRequestDelete="HandleRequestDelete" />
                    }
                </div>
            </div>
        </div>

        <div class="col-md-5 mb-4">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">@((editingTag?.Id == 0) ? "Create Tag" : "Edit Tag")</h5>

                    @if (!string.IsNullOrEmpty(message))
                    {
                        <div class="alert @messageClass" role="status">@message</div>
                    }

                    <TagEditor Tag="editingTag"
                               OnSaved="HandleSaved"
                               OnCancelled="HandleCancelled"
                               IsBusy="isBusy" />
                </div>
            </div>
        </div>
    </div>
</div>

<ConfirmDialog @ref="confirmDialog" Title="Delete tag"
               Message="Are you sure you want to delete this tag? This action cannot be undone."
               OnConfirm="DeleteConfirmed" />

@code {
    private List<TagModel> tags = new();
    private TagModel editingTag = new TagModel();
    private string search = string.Empty;
    private string message = string.Empty;
    private string messageClass = "alert-success";
    private bool isBusy = false;
    private ConfirmDialog? confirmDialog;
    private int? deleteCandidateId;

    protected override async Task OnInitializedAsync()
    {
        await Load();
    }

    private async Task Load()
    {
        isBusy = true;
        message = string.Empty;
        try
        {
            tags = (await TagService.GetAllTagsAsync()) ?? new List<TagModel>();
        }
        catch (Exception ex)
        {
            message = "Failed to load tags.";
            messageClass = "alert-danger";
            Console.WriteLine($"Tags.Load error: {ex}");
        }
        finally
        {
            isBusy = false;
        }
    }

    private IEnumerable<TagModel> FilteredTags
    {
        get
        {
            var list = tags.AsEnumerable();
            if (!string.IsNullOrWhiteSpace(search))
            {
                var q = search.Trim();
                list = list.Where(t => t.Name?.Contains(q, StringComparison.OrdinalIgnoreCase) == true);
            }
            return list.OrderBy(t => t.Name);
        }
    }

    private void CreateNew()
    {
        editingTag = new TagModel();
        message = string.Empty;
    }

    private async Task HandleEdit(int id)
    {
        var t = await TagService.GetTagByIdAsync(id);
        if (t != null)
        {
            editingTag = new TagModel { Id = t.Id, Name = t.Name };
            message = string.Empty;
        }
    }

    private async Task HandleSaved(TagModel saved)
    {
        // refresh list and show confirmation
        await Load();
        message = "Tag saved.";
        messageClass = "alert-success";
        editingTag = new TagModel();
    }

    private Task HandleCancelled()
    {
        editingTag = new TagModel();
        message = string.Empty;
        return Task.CompletedTask;
    }

    private async Task HandleRequestDelete(int id)
    {
        deleteCandidateId = id;
        if (confirmDialog != null)
        {
            await confirmDialog.ShowAsync();
        }
    }

    private async Task DeleteConfirmed()
    {
        if (!deleteCandidateId.HasValue) return;

        try
        {
            await TagService.DeleteTagAsync(deleteCandidateId.Value);
            await Load();
            message = "Tag deleted.";
            messageClass = "alert-success";
        }
        catch (Exception ex)
        {
            message = "Failed to delete tag.";
            messageClass = "alert-danger";
            Console.WriteLine($"Tags.Delete error: {ex}");
        }
        finally
        {
            deleteCandidateId = null;
        }
    }

    private void Cancel()
    {
        editingTag = new TagModel();
        message = string.Empty;
    }

    private void ClearSearch() => search = string.Empty;
}
<style>
/* small page tweaks */
.card { border-radius: 10px; }
.table-responsive { max-height: 420px; overflow: auto; }
</style>
