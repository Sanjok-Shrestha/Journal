@inject IJournalService JournalService

<div class="calendar-view">
    <div class="calendar-header">
        <button class="btn btn-sm" @onclick="PreviousMonth">◀</button>
        <h3>@currentMonth.ToString("MMMM yyyy")</h3>
        <button class="btn btn-sm" @onclick="NextMonth">▶</button>
    </div>

    <div class="calendar-grid">
        @foreach (var day in new[] { "Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat" })
        {
            <div class="calendar-day-header">@day</div>
        }

        @foreach (var day in calendarDays)
        {
            var hasEntry = entryDates.Contains(day.Date);
            var isToday = day.Date == DateTime.Today;
            var isCurrentMonth = day.Month == currentMonth.Month;

            <div class="calendar-day @(hasEntry ? "has-entry" : "") @(isToday ? "today" : "") @(isCurrentMonth ? "" : "other-month")"
                 @onclick="() => SelectDate(day)">
                <div class="day-number">@day.Day</div>
                @if (hasEntry)
                {
                    <div class="entry-indicator"></div>
                }
            </div>
        }
    </div>
</div>

@code {
    [Parameter]
    public EventCallback<DateTime> OnDateSelected { get; set; }

    private DateTime currentMonth = new DateTime(DateTime.Today.Year, DateTime.Today.Month, 1);
    private List<DateTime> calendarDays = new();
    private List<DateTime> entryDates = new();

    protected override async Task OnInitializedAsync()
    {
        await LoadCalendar();
    }

    private async Task LoadCalendar()
    {
        GenerateCalendarDays();
        entryDates = await JournalService.GetEntryDatesAsync(currentMonth.Year, currentMonth.Month);
    }

    private void GenerateCalendarDays()
    {
        calendarDays.Clear();

        var firstDay = new DateTime(currentMonth.Year, currentMonth.Month, 1);
        var lastDay = firstDay.AddMonths(1).AddDays(-1);

        var startDayOfWeek = (int)firstDay.DayOfWeek;
        for (int i = startDayOfWeek - 1; i >= 0; i--)
        {
            calendarDays.Add(firstDay.AddDays(-i - 1));
        }

        for (int day = 1; day <= lastDay.Day; day++)
        {
            calendarDays.Add(new DateTime(currentMonth.Year, currentMonth.Month, day));
        }

        while (calendarDays.Count < 42)
        {
            calendarDays.Add(lastDay.AddDays(calendarDays.Count - lastDay.Day - startDayOfWeek + 1));
        }
    }

    private async Task PreviousMonth()
    {
        currentMonth = currentMonth.AddMonths(-1);
        await LoadCalendar();
    }

    private async Task NextMonth()
    {
        currentMonth = currentMonth.AddMonths(1);
        await LoadCalendar();
    }

    private async Task SelectDate(DateTime date)
    {
        await OnDateSelected.InvokeAsync(date);
    }
}