@using Microsoft.JSInterop
@inject IJSRuntime JS
@implements IDisposable

<div class="rich-text-editor-container">
    <div id="toolbar-@editorId">
        <span class="ql-formats">
            <select class="ql-header">
                <option value="1">Heading 1</option>
                <option value="2">Heading 2</option>
                <option value="3">Heading 3</option>
                <option selected>Normal</option>
            </select>
        </span>
        
        <span class="ql-formats">
            <button class="ql-bold" title="Bold"></button>
            <button class="ql-italic" title="Italic"></button>
            <button class="ql-underline" title="Underline"></button>
            <button class="ql-strike" title="Strikethrough"></button>
        </span>
        
        <span class="ql-formats">
            <select class="ql-color"></select>
            <select class="ql-background"></select>
        </span>
        
        <span class="ql-formats">
            <button class="ql-list" value="ordered" title="Ordered List"></button>
            <button class="ql-list" value="bullet" title="Bullet List"></button>
            <button class="ql-indent" value="-1" title="Decrease Indent"></button>
            <button class="ql-indent" value="+1" title="Increase Indent"></button>
        </span>
        
        <span class="ql-formats">
            <select class="ql-align">
                <option selected></option>
                <option value="center"></option>
                <option value="right"></option>
                <option value="justify"></option>
            </select>
        </span>
        
        <span class="ql-formats">
            <button class="ql-link" title="Insert Link"></button>
            <button class="ql-image" title="Insert Image"></button>
            <button class="ql-code-block" title="Code Block"></button>
        </span>
        
        <span class="ql-formats">
            <button class="ql-blockquote" title="Blockquote"></button>
        </span>
        
        <span class="ql-formats">
            <button class="ql-clean" title="Clear Formatting"></button>
        </span>
    </div>

    <div id="editor-@editorId" class="quill-editor"></div>
</div>

@code {
    private string editorId = Guid.NewGuid().ToString("N");
    private bool isInitialized = false;
    private DotNetObjectReference<RichTextEditor>? dotNetRef;

    [Parameter]
    public string Content { get; set; } = string.Empty;

    [Parameter]
    public EventCallback<string> ContentChanged { get; set; }

    [Parameter]
    public string Placeholder { get; set; } = "Write your thoughts here...";

    [Parameter]
    public int MinHeight { get; set; } = 300;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && !isInitialized)
        {
            await InitializeQuill();
            isInitialized = true;
        }
    }

    private async Task InitializeQuill()
    {
        try
        {
            dotNetRef = DotNetObjectReference.Create(this);
            await JS.InvokeVoidAsync("QuillEditor.initialize",
                editorId,
                Content ?? string.Empty,
                Placeholder,
                MinHeight,
                dotNetRef);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error initializing Quill: {ex.Message}");
        }
    }

    [JSInvokable]
    public async Task OnContentChanged(string html)
    {
        Content = html;
        await ContentChanged.InvokeAsync(html);
    }

    public async Task SetContent(string content)
    {
        if (isInitialized)
        {
            await JS.InvokeVoidAsync("QuillEditor.setContent", editorId, content);
        }
    }

    public async Task<string> GetContent()
    {
        if (isInitialized)
        {
            return await JS.InvokeAsync<string>("QuillEditor.getContent", editorId);
        }
        return Content;
    }

    public void Dispose()
    {
        dotNetRef?.Dispose();
    }
};
