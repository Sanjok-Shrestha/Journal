@inject JournalDbContext DbContext
@inject IAuthenticationService AuthService

<div class="tag-selector">
    <label>Tags</label>
    
    <div class="tag-input-container">
        <input type="text" 
               @bind="newTagName" 
               @bind:event="oninput"
               @onkeydown="HandleKeyDown"
               class="form-control" 
               placeholder="Add a tag and press Enter..." />
        <button type="button" class="btn btn-sm btn-primary" @onclick="AddTag">Add</button>
    </div>

    @if (Tags.Any())
    {
        <div class="selected-tags">
            @foreach (var tag in Tags)
            {
                <span class="tag-chip">
                    @tag
                    <button type="button" class="tag-remove" @onclick="() => RemoveTag(tag)">×</button>
                </span>
            }
        </div>
    }

    <div class="tag-suggestions">
        <small class="text-muted">Suggestions:</small>
        <div class="suggestion-tags">
            @foreach (var suggestion in predefinedTags.Except(Tags).Take(8))
            {
                <button type="button" class="suggestion-tag" @onclick="() => AddPredefinedTag(suggestion)">
                    @suggestion
                </button>
            }
        </div>
    </div>
</div>

@code {
    [Parameter]
    public List<string> Tags { get; set; } = new();

    [Parameter]
    public EventCallback<List<string>> TagsChanged { get; set; }

    private string newTagName = string.Empty;
    
    private readonly List<string> predefinedTags = new()
    {
        "Work", "Personal", "Travel", "Family", "Friends",
        "Health", "Fitness", "Learning", "Goals", "Gratitude",
        "Reflection", "Ideas", "Productivity", "Relaxation", "Celebration"
    };

    private async Task AddTag()
    {
        if (!string.IsNullOrWhiteSpace(newTagName) && !Tags.Contains(newTagName))
        {
            Tags.Add(newTagName.Trim());
            await TagsChanged.InvokeAsync(Tags);
            newTagName = string.Empty;
        }
    }

    private async Task AddPredefinedTag(string tag)
    {
        if (!Tags.Contains(tag))
        {
            Tags.Add(tag);
            await TagsChanged.InvokeAsync(Tags);
        }
    }

    private async Task RemoveTag(string tag)
    {
        Tags.Remove(tag);
        await TagsChanged.InvokeAsync(Tags);
    }

    private async Task HandleKeyDown(KeyboardEventArgs e)
    {
        if (e.Key == "Enter")
        {
            await AddTag();
        }
    }
}