window.QuillEditor = {
    editors: {},

    initialize: function (editorId, initialContent, placeholder, minHeight, dotNetHelper) {
        const toolbarId = `toolbar-${editorId}`;
        const editorElementId = `editor-${editorId}`;

        const quill = new Quill(`#${editorElementId}`, {
            theme: 'snow',
            placeholder: placeholder,
            modules: {
                toolbar: {
                    container: `#${toolbarId}`,
                    handlers: {
                        image: this.imageHandler
                    }
                },
                clipboard: {
                    matchVisual: false
                }
            }
        });

        const editor = document.querySelector(`#${editorElementId} .ql-editor`);
        if (editor) {
            editor.style.minHeight = `${minHeight}px`;
        }

        if (initialContent) {
            quill.root.innerHTML = initialContent;
        }

        quill.on('text-change', function (delta, oldDelta, source) {
            if (source === 'user') {
                const html = quill.root.innerHTML;
                dotNetHelper.invokeMethodAsync('OnContentChanged', html);
            }
        });

        this.editors[editorId] = quill;
    },

    setContent: function (editorId, content) {
        const quill = this.editors[editorId];
        if (quill) {
            quill.root.innerHTML = content || '';
        }
    },

    getContent: function (editorId) {
        const quill = this.editors[editorId];
        if (quill) {
            return quill.root.innerHTML;
        }
        return '';
    },

    imageHandler: function () {
        const input = document.createElement('input');
        input.setAttribute('type', 'file');
        input.setAttribute('accept', 'image/*');
        input.click();

        input.onchange = async () => {
            const file = input.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const range = this.quill.getSelection();
                    this.quill.insertEmbed(range.index, 'image', e.target.result);
                };
                reader.readAsDataURL(file);
            }
        };
    }
};